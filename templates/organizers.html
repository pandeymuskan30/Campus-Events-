<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Organizer - Feedback Analysis & Gallery</title>
   <link rel="stylesheet" href="{{ url_for('static', filename='dist/output.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f7f9fc; }
    .keyword-positive { color: #16a34a; font-weight: bold; }
    .keyword-negative { color: #dc2626; font-weight: bold; }
  </style>
</head>
<body class="antialiased flex flex-col md:flex-row min-h-screen">

  <!-- Sidebar -->
  <aside id="sidebar" class="w-full md:w-64 bg-indigo-700 text-white flex flex-col md:min-h-screen transition-transform transform md:translate-x-0 -translate-x-full md:relative fixed z-50">
    <div class="flex justify-between items-center p-6 border-b border-indigo-500">
      <div class="text-2xl font-bold">Organizer Panel</div>
      <button class="md:hidden" onclick="toggleSidebar()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <nav class="flex-1 p-4 space-y-4">
      <a href="{{ url_for('admin') }}" class="block p-2 rounded hover:bg-indigo-600"><i class="fas fa-chart-line mr-2"></i> Dashboard</a>
      <a href="{{ url_for('all_users') }}" class="block p-2 rounded hover:bg-indigo-600"><i class="fas fa-users mr-2"></i> All Users</a>
      <a href="{{ url_for('index') }}" class="block p-2 rounded hover:bg-indigo-600"><i class="fas fa-globe mr-2"></i> User Site</a>
    </nav>
  </aside>

  <!-- Mobile Menu Button -->
  <button class="fixed top-4 right-4 z-50 md:hidden bg-indigo-700 text-white p-2 rounded-lg shadow-lg" onclick="toggleSidebar()">
    <i class="fas fa-bars"></i>
  </button>

  <!-- Main Content -->
  <main class="flex-1 p-4 md:p-6 overflow-y-auto">

    <!-- Upload Gallery -->
    <h1 class="text-2xl md:text-3xl font-bold text-indigo-700 mb-6">Upload Gallery Image</h1>
    <div class="bg-white shadow-md rounded-2xl p-6 max-w-lg mx-auto mb-12">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="mb-6">
            {% for category, message in messages %}
              <div class="p-3 mb-2 rounded-lg text-white 
                {% if category == 'success' %} bg-green-600 
                {% elif category == 'danger' %} bg-red-600 
                {% else %} bg-gray-600 {% endif %}">
                {{ message }}
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}
      <form action="{{ url_for('add_gallery') }}" method="POST" enctype="multipart/form-data" class="space-y-6">
        <div>
          <label class="block mb-1 font-medium text-gray-700">Event Name</label>
          <input type="text" name="name" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
        </div>
        <div>
          <label class="block mb-1 font-medium text-gray-700">Upload Image</label>
          <input type="file" name="image" accept="image/*" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
        </div>
        <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition-colors duration-200">
          <i class="fas fa-upload mr-2"></i> Upload
        </button>
      </form>
    </div>

    <!-- Gallery List -->
    <h2 class="text-xl font-bold text-indigo-700 mb-4">Manage Gallery</h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 mb-12">
      {% for item in gallery %}
      <div class="bg-white shadow-lg rounded-xl overflow-hidden">
        <img src="{{ url_for('static', filename='uploads/' ~ item.image) }}" alt="{{ item.name }}" class="w-full h-40 object-cover">
        <div class="p-4 flex justify-between items-center">
          <h3 class="text-lg font-bold text-gray-800">{{ item.name }}</h3>
          <form action="{{ url_for('delete_gallery', id=item.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this image?');">
            <button type="submit" class="text-red-600 hover:text-red-800">
              <i class="fas fa-trash"></i>
            </button>
          </form>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Feedback Analysis -->
    <h2 class="text-2xl font-bold text-indigo-700 mb-6">Feedback Analysis</h2>

    <!-- Event Filter -->
    <div class="mb-6 max-w-md">
      <label class="block mb-2 font-medium text-gray-700">Filter by Event:</label>
      <select id="eventFilter" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
        <option value="all">All Events</option>
        {% for event in event_list %}
          <option value="{{ event }}">{{ event }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Sentiment Overview -->
    <div id="sentimentSummary" class="bg-white p-6 rounded-xl shadow-md mb-6">
      <h3 class="text-lg font-semibold text-indigo-700 mb-4">Sentiment Overview</h3>
      <div class="mb-4">
        <div class="w-full bg-gray-200 rounded-full h-6">
          <div id="sentimentBar" class="h-6 rounded-full text-center text-white font-semibold"></div>
        </div>
      </div>
      <p id="overallSentiment" class="font-semibold text-lg mb-4"></p>
      <button id="downloadPDF" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
        <i class="fas fa-file-pdf mr-2"></i> Download PDF
      </button>
    </div>

    <!-- Top Keywords -->
    <div id="topKeywords" class="bg-white p-6 rounded-xl shadow-md mb-6">
      <h3 class="text-lg font-semibold text-indigo-700 mb-4">Top Keywords</h3>
      <div class="flex gap-6 flex-wrap">
        <div>
          <p class="font-semibold text-green-600">Top Positive</p>
          <ul id="topPositive" class="list-disc list-inside text-gray-700"></ul>
        </div>
        <div>
          <p class="font-semibold text-red-600">Top Negative</p>
          <ul id="topNegative" class="list-disc list-inside text-gray-700"></ul>
        </div>
      </div>
    </div>

    <!-- Feedback Messages -->
    <h3 class="text-xl font-semibold text-indigo-700 mb-4">Latest Feedback</h3>
    <div id="feedbackList" class="space-y-4"></div>

  </main>

  <script>
    const sidebar = document.getElementById("sidebar");
    function toggleSidebar() { sidebar.classList.toggle("-translate-x-full"); }

    const feedbackData = JSON.parse('{{ feedback_data | tojson | safe }}');
    const feedbackList = document.getElementById("feedbackList");
    const sentimentBar = document.getElementById("sentimentBar");
    const overallSentiment = document.getElementById("overallSentiment");
    const topPositive = document.getElementById("topPositive");
    const topNegative = document.getElementById("topNegative");

    const positiveKeywords = ['good','great','excellent','fun','well organized','amazing','awesome','fantastic','enjoyable','outstanding','perfect','wonderful','nice','pleasant','superb','impressive','brilliant','positive','love','happy','engaging'];
    const negativeKeywords = ['bad','poor','boring','average','terrible','awful','disappointing','unorganized','frustrating','dull','annoying','horrible','mediocre','unpleasant','lacking','confusing','negative','sad','waste'];

    function updateAnalysis(filterEvent='all'){
      const filtered = filterEvent==='all' ? feedbackData : feedbackData.filter(f => f.event_name===filterEvent);
      let totalPositive=0, totalNegative=0;
      const posCountMap={}, negCountMap={};
      positiveKeywords.forEach(k=>posCountMap[k]=0);
      negativeKeywords.forEach(k=>negCountMap[k]=0);

      feedbackList.innerHTML = '';
      filtered.slice().reverse().forEach(f => {
        const msg = f.message.toLowerCase();
        positiveKeywords.forEach(k => { if(msg.includes(k)) { totalPositive++; posCountMap[k]++; } });
        negativeKeywords.forEach(k => { if(msg.includes(k)) { totalNegative++; negCountMap[k]++; } });

        const div = document.createElement('div');
        div.className='bg-white p-4 rounded-lg shadow-md';
        div.innerHTML = `<p><span class="font-semibold">${f.username}</span> on <span class="font-medium">${f.event_name}</span>:</p>
                         <p class="text-gray-600">${f.message}</p>`;
        feedbackList.appendChild(div);
      });

      const total = totalPositive + totalNegative;
      const positivePercent = total ? (totalPositive/total)*100 : 50;
      sentimentBar.style.width = positivePercent+'%';
      sentimentBar.style.backgroundColor = positivePercent>=50?'#16a34a':'#dc2626';
      sentimentBar.textContent = `${totalPositive} Positive / ${totalNegative} Negative`;

      if(total===0){
        overallSentiment.textContent="No keywords detected in feedback.";
        overallSentiment.className="font-semibold text-gray-700";
      } else {
        const score=(totalPositive-totalNegative)/total;
        if(score>0.2){ overallSentiment.textContent="Overall Sentiment: Positive"; overallSentiment.className="font-semibold text-green-600"; }
        else if(score<-0.2){ overallSentiment.textContent="Overall Sentiment: Negative"; overallSentiment.className="font-semibold text-red-600"; }
        else{ overallSentiment.textContent="Overall Sentiment: Neutral"; overallSentiment.className="font-semibold text-yellow-600"; }
      }

      const sortedPos=Object.entries(posCountMap).sort((a,b)=>b[1]-a[1]).slice(0,3);
      const sortedNeg=Object.entries(negCountMap).sort((a,b)=>b[1]-a[1]).slice(0,3);
      topPositive.innerHTML=sortedPos.map(k=>`<li>${k[0]}: ${k[1]}</li>`).join('');
      topNegative.innerHTML=sortedNeg.map(k=>`<li>${k[0]}: ${k[1]}</li>`).join('');
    }

    updateAnalysis();
    document.getElementById('eventFilter').addEventListener('change', e => updateAnalysis(e.target.value));

    // PDF Download
    const { jsPDF } = window.jspdf;
    document.getElementById('downloadPDF').addEventListener('click', ()=>{
      const doc = new jsPDF();
      const eventName = document.getElementById('eventFilter').value || "All_Events";

      doc.setFontSize(18);
      doc.text(`Feedback Analysis - ${eventName}`, 10, 20);
      doc.setFontSize(14);
      doc.text(`Overall Sentiment: ${overallSentiment.textContent.replace('Overall Sentiment: ', '')}`, 10, 30);

      // Initialize y-coordinate
      let y = 40;
      Array.from(document.querySelectorAll('#feedbackList .bg-white')).forEach(div=>{
        const user = div.querySelector('p span.font-semibold').innerText.trim();
        const event = div.querySelector('p span.font-medium').innerText.trim();
        const msg = div.querySelector('p.text-gray-600').innerText.trim();

        const header = `${user} on ${event}:`;
        const lines = doc.splitTextToSize(msg, 180);

        doc.text(header, 12, y);
        y+=6;
        doc.text(lines, 14, y);
        y+=lines.length*6 +4;

        if(y>280){ doc.addPage(); y=20; }
      });

      doc.save(`${eventName.replace(/\s+/g,'_')}_feedback_analysis.pdf`);
    });


  </script>
</body>
</html>